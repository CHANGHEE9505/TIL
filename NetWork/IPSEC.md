# 📘 IPSec (Internet Protocol Security)

## 1. 개요

> 🔐 **IPSec은 OSI 7계층 중 3계층(네트워크 계층)에서 동작하는 암호화 프로토콜입니다.**

- 서버 간 데이터 교류 중 **전송되는 패킷을 암호화**하여 **보안 위협으로부터 보호**합니다.
- **안전하지 않은 네트워크에서도** 두 컴퓨터 간 **안전한 통신을 보장**합니다.
- IPSec은 하나의 프로토콜이 아닌, **보안 통신을 위한 프로토콜들의 집합**입니다.

---

## 2. IPSec 사용이 필요한 이유

> 🛡️ **네트워크 공격(특히 스니핑, MITM 공격)을 방어하기 위해 사용됩니다.**

- `Wireshark` 같은 툴로 네트워크 트래픽을 **실시간으로 엿볼 수 있음**
- 허브 환경에서는 **중간자 공격(MITM)** 성공 시, 패킷 내용을 **그대로 탈취 가능**
- 암호화되지 않은 트래픽은 **개인정보 유출**로 이어질 수 있음

💡 따라서, IPSec을 사용하여 패킷을 암호화하면 **데이터를 안전하게 보호**할 수 있습니다.

---

## IPSec이 제공하는 보안 기능

| 기능 | 설명 |
|------|------|
| **AH** (Authentication Header) | ✔️ 무결성 보장<br>✔️ 출처 인증<br>❌ 데이터 기밀성은 보장하지 않음 |
| **ESP** (Encapsulating Security Payload) | ✔️ 무결성 + 기밀성 모두 보장<br>✔️ 데이터 암호화<br>✔️ 리플레이 공격 방지 |

📌 **ESP는 실질적인 암호화 + 무결성을 동시에 제공**하여 보안 수준이 높습니다.

---

## ✅ 정리

- IPSec은 **암호화 + 인증** 기능을 제공하는 **네트워크 보안 핵심 기술**
- 외부로부터의 **스니핑, 패킷 변조, 도청 공격을 방지**
- 실제로 VPN, 기업 내부망 보안 등에 널리 활용됨

## ✅ IPSec는 3가지만 알면 끝!

---

### 1. 적용 환경에 따른 구성 (2가지)

| 구성 방식       | 설명                         |
|----------------|------------------------------|
| **Host to Host** | 시스템 간 1:1 통신 구성       |
| **Site to Site** | 네트워크 간 N:N 통신 구성    |

📌 Host 간 직접 통신이 필요한 경우와  
VPN처럼 네트워크 단위 연결이 필요한 경우로 나뉩니다.

---

### 2. 방화벽 작동 유무에 따른 구성 (2가지)

| 방화벽 상태                    | 설정 방식                                 |
|-------------------------------|-------------------------------------------|
| **방화벽 미작동**             | `로컬 보안 정책` 설정 (`secpol.msc`) 사용 |
| **방화벽 작동 중**            | `고급 보안이 포함된 Windows 방화벽` (`wf.msc`) 사용 |

📌 보안 정책 설정 위치가 방화벽 상태에 따라 달라지므로 구분해서 적용해야 합니다.

---

### 3. 규칙 적용 방식 (3가지)

| 방식           | 설명                               |
|----------------|------------------------------------|
| **PSK 방식**     | 사전 공유 키(Pre-Shared Key)를 이용한 인증 |
| **Kerberos 방식** | Active Directory 기반 사용자 인증     |
| **CA 인증 방식**  | 인증기관(Certificate Authority)을 통한 공개키 인증 |

📌 보안 수준에 따라 적절한 인증 방식을 선택합니다.  
(공식 환경에서는 보통 **CA 인증 방식**을 권장)

---

## 4. 실습 1. PSK

---

### ✅ 예제 개요

- **실습 목표**: IPSec을 활용한 사전 공유 키(PSK) 기반의 Host-to-Host 보안 통신 구성
- **시스템 구성**:
  - `SRV100`: Windows Server 2022
  - `Client100`: Windows 10
- **환경 조건**:
  - 통신 방식: **Host to Host (HtoH)**
  - 방화벽: **비활성화 (wf.msc ❌)**
  - 인증 방식: **PSK (Pre-Shared Key)**

---

### 🔁 사전 확인

- SRV100 <-> Client100 간 **ping 테스트로 통신 가능 여부 확인**

---

### ⚙️ 보안 정책 설정: `secpol.msc`

> `시작 > 실행 > secpol.msc` 실행 후 아래 절차대로 진행

#### 1. 보안 정책 생성

- `IP 보안 정책` > 우클릭 > **"IP 보안 정책 만들기"**
- 이름: `IPSec_PSK_Test`
- 마법사 진행

<br>

![1](./img/IPSec.img/1.png)<br>
![2](./img/IPSec.img/2.png)<br>
![3](./img/IPSec.img/3.png)<br>
![4](./img/IPSec.img/4.png)<br>
![5](./img/IPSec.img/5.png)<br>

---

### 📍 IP 필터 목록 생성

- 새 필터 목록 추가  
- **Source**: 상대 시스템의 IP  
- **Destination**: 내 IP

<br>

![6](./img/IPSec.img/6.png)<br>
![7](./img/IPSec.img/7.png)<br>
→ 설정 완료 시 상태 화면:

![8](./img/IPSec.img/8.png)<br>

- [새 IP 필터 목록] 버튼 클릭

![9](./img/IPSec.img/9.png)<br>

---

### 🔧 필터 동작 구성

> 필터 동작: `요구 보안` 또는 `협상`

<br>

![10](./img/IPSec.img/10.png)<br>
![11](./img/IPSec.img/11.png)<br>
![12](./img/IPSec.img/12.png)<br>
![13](./img/IPSec.img/13.png)<br>

---

### 🔑 인증 방법 설정 (PSK)

- 사전 공유 키 입력: 예) `1234`

<br>

![14](./img/IPSec.img/14.png)<br>
![15](./img/IPSec.img/15.png)<br>

---

### 🧪 테스트 절차

#### ✅ 테스트 1: 정책 적용 전

- Wireshark(샥스핀) 실행 → **ICMP 패킷 노출됨**
  
  ![](./img/IPSec.img/16.png)<br>

---

#### ✅ 정책 설정 및 적용

- **SRV100**: 위와 같이 정책 생성 완료
- **Client100**: 동일 방식으로 동일 정책 생성
  ![](./img/IPSec.img/17.png)<br>

- 생성한 보안 정책 우클릭 → **[할당] 선택**
- 할당 여부가 `예`로 변경되어야 함
  ![](./img/IPSec.img/19.png)<br>

- **Client100**에서도 동일하게 적용

---

#### ✅ 테스트 2: 정책 적용 후

- 다시 Wireshark(샥스핀) 실행
- ICMP는 보이지만 **암호화된 ESP 패킷으로 변경되어 있어야 함**

  ![](./img/IPSec.img/18.png)<br>

- `ping` 명령으로 통신 확인

  ![](./img/IPSec.img/21.png)<br>

- Client100에서 Wireshark로 확인

  ![](./img/IPSec.img/20.png)<br>

---

### ✅ 정리

| 항목       | 결과 및 상태                     |
|------------|----------------------------------|
| ping       | 정상 작동                        |
| 보안 정책 | 할당 상태로 변경됨 (`예`)         |
| Wireshark | 암호화된 ESP 패킷 확인 가능 여부   |


